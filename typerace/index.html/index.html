<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chaos Circuit</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      background: #333;
      display: block;
      margin: auto;
    }
    #menu, #shop, #garage, #spin, #race, #endScreen {
      display: none;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      background: #555;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #777; }
    #endScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      overflow-y: auto;
    }
    #leaderboard {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 8px;
      text-align: left;
    }
    #leaderboard h3 { margin: 0; font-size: 18px; }
    #leaderboard ol { padding-left: 20px; margin: 0; }
    #leaderboard li { font-size: 14px; margin: 2px 0; }
    table {
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid white;
      padding: 8px 12px;
    }
  </style>
</head>
<body>
  <h1>Chaos Circuit</h1>

  <!-- Menu -->
  <div id="menu">
    <button onclick="showScreen('shop')">Shop</button>
    <button onclick="showScreen('garage')">Garage</button>
    <button onclick="showScreen('spin')">Lucky Spin</button>
    <button onclick="startRace()">Play</button>
  </div>

  <!-- Shop -->
  <div id="shop">
    <h2>Shop</h2>
    <p>Buy cars, tracks, tires, and drivers here (non-exclusive).</p>
    <button onclick="showScreen('menu')">Back</button>
  </div>

  <!-- Garage -->
  <div id="garage">
    <h2>Garage</h2>
    <p>Equip cars, tires, drivers, and titles here.</p>
    <button onclick="showScreen('menu')">Back</button>
  </div>

  <!-- Lucky Spin -->
  <div id="spin">
    <h2>Lucky Spin</h2>
    <p><strong>Possible rewards:</strong></p>
    <ul>
      <li>💰 5x money boost</li>
      <li>💵 500 coins</li>
      <li>👤 Driver: Spinner The Winner (medium)</li>
      <li>🛞 Tire: Spinny McWheeley (+30%)</li>
      <li>🛞 Tire: Shadow Tire (+45%)</li>
    </ul>
    <button onclick="spinWheel()">Spin</button>
    <p id="spinResult"></p>
    <button onclick="showScreen('menu')">Back</button>
  </div>

  <!-- Race -->
  <div id="race">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="leaderboard">
      <h3>Leaderboard</h3>
      <ol id="leaderboardList"></ol>
    </div>
    <p id="raceInfo"></p>
    <button onclick="endRace()">Return to Menu</button>
  </div>

  <!-- End Screen -->
  <div id="endScreen">
    <h1 id="endMessage"></h1>
    <div id="bigCars">
      🚗 🚙 🏎️ 🚕 🚘 🚖 🚔 🚍
    </div>
    <h2>Final Results</h2>
    <table id="resultsTable">
      <tr><th>Place</th><th>Name</th><th>Laps</th></tr>
    </table>
    <button onclick="closeEndScreen()">Close</button>
  </div>

  <script>
    // ---------------- GLOBAL STATE ----------------
    let screen = "menu";
    let lastSpin = localStorage.getItem("lastSpin") || 0;
    let spinCooldown = 10 * 60 * 60 * 1000; // 10 hours
    let ctx, canvas, trackPath, players = [];
    let lapsToWin = 3;
    let keys = {};
    let raceActive = false;

    const ranks = [
      "Rookie Driver","Amateur Cruiser","Speed Demon","Master Controller",
      "Turbo Legend","Royal Racer","FlashPoint","Supreme Champion",
      "The OG GOAT","MAX VERSTAPPEN"
    ];

    const aiNames = [
      "NitroKing","Speedy99","Zoomer","RapidFire","ShadowWheel","BurnoutX",
      "DriftDemon","TorqueMaster","RallyRider","Slipstream","Overdrive",
      "RoadRager","TrackPhantom","PistonPete","TireSlayer"
    ];

    // ---------------- SCREEN MANAGER ----------------
    function showScreen(name) {
      document.querySelectorAll("#menu,#shop,#garage,#spin,#race,#endScreen")
        .forEach(div => div.style.display = "none");
      document.getElementById(name).style.display = "block";
      screen = name;
    }

    // ---------------- LUCKY SPIN ----------------
    function spinWheel() {
      let now = Date.now();
      if (now - lastSpin < spinCooldown) {
        let wait = Math.ceil((spinCooldown - (now - lastSpin))/1000/60);
        document.getElementById("spinResult").innerText = "⏳ Wait " + wait + " more minutes.";
        return;
      }
      lastSpin = now;
      localStorage.setItem("lastSpin", lastSpin);

      let rewards = [
        "💰 5x money boost",
        "💵 500 coins",
        "👤 Driver: Spinner The Winner",
        "🛞 Tire: Spinny McWheeley (+30%)",
        "🛞 Tire: Shadow Tire (+45%)"
      ];
      let reward = rewards[Math.floor(Math.random()*rewards.length)];
      document.getElementById("spinResult").innerText = "🎉 You won: " + reward;
    }

    // ---------------- RACE SETUP ----------------
    function startRace() {
      showScreen("race");
      canvas = document.getElementById("gameCanvas");
      ctx = canvas.getContext("2d");
      setupTrack();
      setupPlayers();
      raceActive = true;
      requestAnimationFrame(gameLoop);
    }

    function setupTrack() {
      trackPath = [
        {x:100, y:100}, {x:700, y:100},
        {x:700,y:500}, {x:100,y:500}
      ]; // rectangular track
    }

    function setupPlayers() {
      players = [];
      // Player
      players.push({name:"YOU", x:120,y:120,color:"cyan",lap:0,angle:0,speed:0,isBot:false,target:0,finished:false});

      // AI
      for(let i=0;i<4;i++){
        let name = aiNames[Math.floor(Math.random()*aiNames.length)];
        let rank = ranks[Math.floor(Math.random()*ranks.length)];
        players.push({
          name:name,
          rank:rank,
          x:120+(i*30), y:150,
          color:["red","green","blue","yellow"][i],
          lap:0, angle:0, speed:0.5,
          isBot:true, target:0, finished:false
        });
      }

      // Big Bad Boy spawn chance (15%)
      if(Math.random() < 0.15) {
        players[players.length-1] = {
          name:"The Big Bad Boy",
          rank:"Supreme Champion",
          driver:"Leclerc",
          tires:"Big Bad Tires (50%)",
          car:"Void Car",
          x:150,y:170,
          color:"purple",
          lap:0, angle:0, speed:0.9,
          isBot:true, target:0, finished:false
        };
      }
    }

    // ---------------- RACE LOOP ----------------
    function gameLoop() {
      if(!raceActive) return;

      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Draw track
      ctx.lineWidth = 80;
      ctx.strokeStyle = "#555";
      ctx.beginPath();
      ctx.moveTo(trackPath[0].x, trackPath[0].y);
      for(let p of trackPath){ ctx.lineTo(p.x,p.y); }
      ctx.closePath();
      ctx.stroke();

      // Finish line
      ctx.fillStyle = "white";
      ctx.fillRect(trackPath[0].x-20, trackPath[0].y-20, 40, 40);

      // Update players
      for (let p of players) {
        if(p.finished) { drawPlayer(p); continue; }
        if(p.isBot) botLogic(p);
        else playerLogic(p);

        // Check finish line for lap
        if(Math.abs(p.x-trackPath[0].x)<20 && Math.abs(p.y-trackPath[0].y)<20){
          if(!p.justCrossed){
            p.lap++;
            p.justCrossed = true;
            if(p.lap>=lapsToWin && !p.finished){
              p.finished = true;
              checkWinner(p);
            }
          }
        } else {
          p.justCrossed = false;
        }

        drawPlayer(p);
      }

      updateLeaderboard();
      requestAnimationFrame(gameLoop);
    }

    function drawPlayer(p){
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x,p.y,10,0,Math.PI*2);
      ctx.fill();
      ctx.fillText(p.name+" (Lap:"+p.lap+")", p.x-15, p.y-15);
    }

    function playerLogic(player){
      let accel = 0.2;
      if(keys["w"]) player.speed += accel;
      if(keys["s"]) player.speed -= accel;
      if(keys["a"]) player.angle -= 0.05;
      if(keys["d"]) player.angle += 0.05;
      player.speed *= 0.95;
      player.x += Math.cos(player.angle)*player.speed;
      player.y += Math.sin(player.angle)*player.speed;
    }

    function botLogic(bot){
      let rankSpeed = rankToSpeed(bot.rank || "Rookie Driver");
      let target = trackPath[bot.target];
      let dx = target.x - bot.x, dy = target.y - bot.y;
      let dist = Math.hypot(dx,dy);
      if(dist<25){ bot.target=(bot.target+1)%trackPath.length; }
      else {
        bot.x += dx/dist * rankSpeed;
        bot.y += dy/dist * rankSpeed;
      }
    }

    function rankToSpeed(rank){
      switch(rank){
        case "Rookie Driver": return 0.4;
        case "Amateur Cruiser": return 0.5;
        case "Speed Demon": return 0.55;
        case "Master Controller": return 0.6;
        case "Turbo Legend": return 0.65;
        case "Royal Racer": return 0.7;
        case "FlashPoint": return 0.75;
        case "Supreme Champion": return 0.8;
        case "The OG GOAT": return 0.85;
        case "MAX VERSTAPPEN": return 1.0;
        default: return 0.5;
      }
    }

    function updateLeaderboard(){
      players.sort((a,b)=> b.lap - a.lap);
      let list = document.getElementById("leaderboardList");
      list.innerHTML = "";
      for(let p of players){
        let li = document.createElement("li");
        li.innerText = p.name + " (Lap " + p.lap + ")";
        list.appendChild(li);
      }
    }

    function checkWinner(player){
      raceActive = false;
      if(player.name==="YOU"){
        document.getElementById("endMessage").innerText = "🏆 YOU WIN! 🏆";
      } else {
        document.getElementById("endMessage").innerText = player.name + " won the race!";
      }
      fillResultsTable();
      showScreen("endScreen");
    }

    function fillResultsTable(){
      let table = document.getElementById("resultsTable");
      table.innerHTML = "<tr><th>Place</th><th>Name</th><th>Laps</th></tr>";
      players.sort((a,b)=> b.lap - a.lap);
      players.forEach((p,i)=>{
        let row = document.createElement("tr");
        row.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p.lap}</td>`;
        table.appendChild(row);
      });
    }

    function closeEndScreen(){
      showScreen("menu");
    }

    function endRace() {
      raceActive = false;
      showScreen("menu");
    }

    // ---------------- CONTROLS ----------------
    window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
    window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    // ---------------- INIT ----------------
    showScreen("menu");
  </script>
</body>
</html>
